<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ì‚°ì±… ì¹œêµ¬ ì°¾ê¸° (ì§€ë„)</title>
	<style>
	        body { margin: 0; padding: 0; font-family: sans-serif; }
	        #map { width: 100%; height: 50vh; }
	        .container { padding: 20px; background-color: #f9f9f9; height: 50vh; overflow-y: auto; }
	        .card {
	            background: white; padding: 15px; margin-bottom: 10px;
	            border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
	            border-left: 5px solid #4CAF50; cursor: pointer;
	        }
	        .card:hover { background-color: #f0f8f0; }
	        .score { float: right; font-weight: bold; color: #e91e63; }
	        .loading { text-align: center; padding: 20px; color: #666; }
	    </style>

	<script type="text/javascript"
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=407503af1dc64fb186371b96a0168a25"></script>
</head>
<body>

    <div id="map"></div>

    <div class="container">
        <h2>ğŸ“ ë‚´ ì£¼ë³€ ì¶”ì²œ ì¹œêµ¬</h2>
        <div id="list-area" class="loading">GPS ìœ„ì¹˜ë¥¼ ì°¾ëŠ” ì¤‘...ğŸ›°ï¸</div>
    </div>

    <script>
        var map;
        const myId = 1; // í…ŒìŠ¤íŠ¸ìš© ë‚´ ID (ë‚˜ì¤‘ì—” ì„¸ì…˜ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)

        window.onload = function() {
            // 1. ë¸Œë¼ìš°ì €ê°€ GPSë¥¼ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸
            if (navigator.geolocation) {
                // 2. í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° (ì„±ê³µì‹œ showPosition ì‹¤í–‰)
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                // ì§€ì› ì•ˆ í•˜ë©´ ê°•ë‚¨ì—­ìœ¼ë¡œ ê¸°ë³¸ ì„¤ì •
                initMap(37.4979, 127.0276); 
            }
        };

        // ìœ„ì¹˜ ì°¾ê¸° ì„±ê³µí–ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
        function showPosition(position) {
            var lat = position.coords.latitude;
            var lon = position.coords.longitude;
            
            console.log("ğŸ“ ë‚´ ìœ„ì¹˜ ì°¾ê¸° ì„±ê³µ:", lat, lon);
            initMap(lat, lon); // ë‚´ ìœ„ì¹˜ë¡œ ì§€ë„ ê·¸ë¦¬ê¸° ì‹œì‘!
        }

        // ìœ„ì¹˜ ì°¾ê¸° ì‹¤íŒ¨í–ˆì„ ë•Œ (ê¶Œí•œ ê±°ë¶€ ë“±)
        function showError(error) {
            alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ 'ê°•ë‚¨ì—­' ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.");
            initMap(37.4979, 127.0276); // ì‹¤íŒ¨ ì‹œ ê°•ë‚¨ì—­
        }

        // ì§€ë„ ê·¸ë¦¬ê³  ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ë©”ì¸ í•¨ìˆ˜
        async function initMap(lat, lon) {
            var container = document.getElementById('map');
            var options = { center: new kakao.maps.LatLng(lat, lon), level: 5 };
            map = new kakao.maps.Map(container, options);

            // ğŸ“ [ì¤‘ìš”] ë‚´ ìœ„ì¹˜ì— 'ë¹¨ê°„ ë§ˆì»¤' í‘œì‹œ (ì´ë¯¸ì§€ ë§ˆì»¤ ëŒ€ì‹  ê¸°ë³¸ ë§ˆì»¤ ì‚¬ìš©)
            var myPosition = new kakao.maps.LatLng(lat, lon);
            var myMarker = new kakao.maps.Marker({ position: myPosition });
            myMarker.setMap(map);

            // ë‚´ ìœ„ì¹˜ë¼ê³  ë§í’ì„  ë‹¬ê¸°
            var iwContent = '<div style="padding:5px; font-weight:bold;">ğŸ™‹â€â™‚ï¸ ë‚˜ ì—¬ê¸° ìˆì–´ìš”!</div>';
            var infowindow = new kakao.maps.InfoWindow({ position : myPosition, content : iwContent });
            infowindow.open(map, myMarker);

            // ğŸ“¡ ì„œë²„ì— ë‚´ ìœ„ì¹˜ ë³´ë‚´ì„œ ì£¼ë³€ ì¹œêµ¬ ì¶”ì²œë°›ê¸°
            loadNearbyWalkers(lat, lon);
        }

        async function loadNearbyWalkers(lat, lon) {
            const listArea = document.getElementById('list-area');
            listArea.innerText = "ì¹œêµ¬ë“¤ì„ ì°¾ëŠ” ì¤‘...";

            try {
                const response = await fetch(`/api/walkers/recommend?myId=${myId}&lat=${lat}&lon=${lon}`);
                
                if (response.status === 403) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    window.location.href = "/index.html";
                    return;
                }

                const data = await response.json();
                listArea.innerHTML = ''; // ë¡œë”© ë¬¸êµ¬ ì œê±°

                if (data.length === 0) {
                    listArea.innerHTML = '<div class="loading">ë°˜ê²½ 3km ë‚´ì— ì‚°ì±… ì¹œêµ¬ê°€ ì—†ë„¤ìš” ã… ã… </div>';
                    return;
                }

                data.forEach(walker => {
                    // ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
                    const html = `
                        <div class="card" onclick="moveTo(${walker.latitude}, ${walker.longitude})">
                            <span class="score">${walker.matchScore}ì </span>
                            <h3>ğŸ¶ ${walker.name} <small>(${walker.dogSize})</small></h3>
                            <div>ê±°ë¦¬: ${walker.distanceMeters}m</div>
                        </div>
                    `;
                    listArea.innerHTML += html;

                    // ì§€ë„ ë§ˆì»¤ ì¶”ê°€
                    var markerPosition  = new kakao.maps.LatLng(walker.latitude, walker.longitude); 
                    var marker = new kakao.maps.Marker({ position: markerPosition });
                    marker.setMap(map);

                    // í´ë¦­ ì‹œ ì¸í¬ìœˆë„ìš°
                    var iwContent = `<div style="padding:5px;">${walker.name} <br><small>${walker.matchScore}ì </small></div>`;
                    var infowindow = new kakao.maps.InfoWindow({ position : markerPosition, content : iwContent });
                    // infowindow.open(map, marker); // ë„ˆë¬´ ì§€ì €ë¶„í•˜ë©´ ì£¼ì„ ì²˜ë¦¬
                });

            } catch (e) {
                console.error(e);
                listArea.innerText = "ë°ì´í„° ë¡œë”© ì‹¤íŒ¨";
            }
        }

        function moveTo(lat, lon) {
            var moveLatLon = new kakao.maps.LatLng(lat, lon);
            map.panTo(moveLatLon);
        }
    </script>
</body>
</html>